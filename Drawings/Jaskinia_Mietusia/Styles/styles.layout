encoding utf-8

# Translation fixes
text pl "units m" "m"
text pl "point station:temporary" "punkt pomiarowy"
text pl "area water" "woda"
text pl "area sump" "syfon"

layout water-blue  # Make water look blue
  code metapost
    def a_water (expr p) =
      T:=identity;
      thfill p withcolor (0.62, 0.79, 0.90);  
    enddef;
  endcode
endlayout water-blue

layout sump-blue  # Make sump look blue
  code metapost
    def a_sump (expr p) =
      T:=identity;
      thfill p withcolor (0.30, 0.47, 0.65);
    enddef;
  endcode  
endlayout sump-blue

layout passage-yellow
  # Colour of the passage
  colour map-fg [100 99 81]

  # Color of map background
  # colour map-bg [70 90 70]  
endlayout passage-yellow

layout clean

  copy water-blue
  copy sump-blue
  copy passage-yellow
  
  language pl  

  grid bottom
  grid-size 25 25 25 m

  # Legend options:
  # legend on
  map-header 0 80 w
  map-header-bg on
  statistics topo-length off
  statistics explo-length off

  symbol-set BCRA

  code tex-map
    %%% 
    % Fix missing ogonek command
    %%%
    \dimendef\platleft=0 \dimendef\platdown=1 
    \dimendef\platright=2 \dimendef\plattemp=3

    \def\sob#1#2#3#4#5{%
        \setbox0\hbox{#1}\setbox1\hbox{\accent24{}}\setbox2\hbox{p}%
        \platright=#2\wd0 \advance\platright by-#3\wd1
        \platdown=#5\ht1 \advance\platdown by-#4\ht0
        \platleft=\platright \advance\platleft by\wd1
        \plattemp=-\platdown \advance\plattemp by\dp2 \dp1=\plattemp
        \leavevmode\kern\platright\lower\platdown\box1\kern-\platleft #1}
    
    \def\aob{\sob a{.50}{.20}{0.07}{.90}}    
    \def\Aob{\sob A{.80}{.50}{0.07}{.90}}
    \def\eob{\sob e{.50}{.35}{0.07}{.93}}
    \def\Eob{\sob E{.60}{.35}{0.07}{.90}}
    
    \def\k#1{%
        \ifx#1a\aob%
        \else\ifx#1A\Aob%
        \else\ifx#1e\eob%
        \else\ifx#1E\Eob%
        \fi\fi\fi\fi}
    %%%    
    % End missing ogonek command
    %%%
    
    \newtoks\license

    %%%
    % Cave and survey information block
    %%%
    \cavename={Jaskinia Mi\k{e}tusia}
    \cavelengthtitle={d\l{}ugość} %fix "ł" char
    \cavedepthtitle={g\l{}\k{e}bokość}
    \topotitle={autorzy}
    \topoteam={_placeholder_}
    \def\authorslist{\par
    {\bf Speleoklub Warszawski:}
    {Jan Grzeszek},
    {Joanna Jurczyk},\par
    {Marcin Lewandowski},
    {Stanislaw Mielarczek},
    {Pawe\l{} Nowikowski},\par
    {Radost Waszkiewicz}}

    \license={CC BY-SA 4.0}
    
    %%%
    % Map layout section
    %%%    
    \def\maplayout{
      \legendbox{65}{-10}{SW}{\the\legendcontent}
      \legendbox{20}{80}{center}{\northarrow}
    }
    
    %%%
    % Legend formatting section
    %%%
    \legendcontent={%
      \hsize=\legendwidth
      \black\the\legendtextcolor 
      
      %\ifnortharrow
      %  \setbox\tmpboxa=\hbox{\northarrow}%
      %  \tmpdimen=\dimexpr(\wd\tmpboxa+10pt)%
      %  \vbox to 0pt{\line{\hfil\box\tmpboxa}\vss}%
      %\fi

      \edef\tmp{\the\cavename} \ifx\tmp\empty \else
        \nointerlineskip
        \vskip\lineskip%
        {\rightskip=\tmpdimen plus 10em\the\legendtextheadersize\the\cavename\par}\vskip1cm
      \fi

      \ifscalebar\scalebar\vskip1cm\fi

      {        
        \edef\tmp{\the\cavelength} \ifx\tmp\empty \else
        {\the\legendtextsize\si\the\cavelengthtitle: \ss\the\cavelength\par}
        \fi

        \edef\tmp{\the\cavedepth} \ifx\tmp\empty \else
        {\the\legendtextsize\si\the\cavedepthtitle: \ss\the\cavedepth\par}
        \fi

        \edef\tmp{\the\topoteam} \ifx\tmp\empty \else
        {\the\legendtextsize\si\the\topotitle: \ss\authorslist\quad\si\the\topodate\par}
        \fi

        \edef\tmp{\the\license} \ifx\tmp\empty \else
        {\vskip 1 em\the\legendtextsize\ss\the\license\par}
        \fi
      }
      \formattedlegend
      \black
    }
  endcode
  
endlayout

layout debug

  grid bottom
  grid-size 25 25 25 m

  colour map-fg [80 80 80]
  colour map-bg [70 90 70]

  debug all

endlayout
